package br.com.dfe.service;

import static org.assertj.core.api.Assertions.*;
import org.junit.Test;
import org.springframework.beans.factory.annotation.Autowired;

import br.com.dfe.MainTest;
import br.com.dfe.api.TipoEmissao;
import br.com.dfe.api.XMLConverter;
import br.com.dfe.configuracao.DadosRequisicao;
import br.com.dfe.schema.TEnviNFe;

public class QrCodeServiceTest extends MainTest {
	
	@Autowired
	private QrCodeService qrCodeService;
	
	@Autowired
	private XMLConverter mapper;

	@Test
	public void test() throws Exception {
		String xmlEnviNFe = "<enviNFe xmlns=\"http://www.portalfiscal.inf.br/nfe\" versao=\"4.00\"><idLote>1</idLote><indSinc>1</indSinc><NFe xmlns=\"http://www.portalfiscal.inf.br/nfe\"><infNFe versao=\"4.00\" Id=\"NFe41190429982424000180650010000014411007910037\"><ide><cUF>41</cUF><cNF>00791003</cNF><natOp>VENDA</natOp><mod>65</mod><serie>1</serie><nNF>1441</nNF><dhEmi>2019-04-04T13:37:00-03:00</dhEmi><tpNF>1</tpNF><idDest>1</idDest><cMunFG>4104808</cMunFG><tpImp>4</tpImp><tpEmis>1</tpEmis><cDV>7</cDV><tpAmb>1</tpAmb><finNFe>1</finNFe><indFinal>1</indFinal><indPres>1</indPres><procEmi>0</procEmi><verProc>1.7.0.78</verProc></ide><emit><CNPJ>29982424000180</CNPJ><xNome>M MASTER GAS EIRELI</xNome><xFant>M MASTER GAS EIRELI</xFant><enderEmit><xLgr>RUA VISCONDE DE GUARAPUAVA</xLgr><nro>1251</nro><xBairro>NEVA</xBairro><cMun>4104808</cMun><xMun>CASCAVEL</xMun><UF>PR</UF><CEP>85802120</CEP><cPais>1058</cPais><xPais>BRASIL</xPais></enderEmit><IE>9077595713</IE><CRT>1</CRT></emit><det nItem=\"1\"><prod><cProd>000001</cProd><cEAN>SEM GTIN</cEAN><xProd>AGUA MINERAL 20 LITROS</xProd><NCM>22011000</NCM><EXTIPI>00</EXTIPI><CFOP>5102</CFOP><uCom>UN</uCom><qCom>4.0000</qCom><vUnCom>8.0000000000</vUnCom><vProd>32.00</vProd><cEANTrib>SEM GTIN</cEANTrib><uTrib>UN</uTrib><qTrib>4.0000</qTrib><vUnTrib>8.0000000000</vUnTrib><indTot>1</indTot></prod><imposto><vTotTrib>4.64</vTotTrib><ICMS><ICMSSN102><orig>0</orig><CSOSN>102</CSOSN></ICMSSN102></ICMS><PIS><PISOutr><CST>49</CST><qBCProd>4.0000</qBCProd><vAliqProd>0.0000</vAliqProd><vPIS>0.00</vPIS></PISOutr></PIS><COFINS><COFINSOutr><CST>49</CST><qBCProd>4.0000</qBCProd><vAliqProd>0.0000</vAliqProd><vCOFINS>0.00</vCOFINS></COFINSOutr></COFINS></imposto></det><total><ICMSTot><vBC>0.00</vBC><vICMS>0.00</vICMS><vICMSDeson>0.00</vICMSDeson><vFCP>0.00</vFCP><vBCST>0.00</vBCST><vST>0.00</vST><vFCPST>0.00</vFCPST><vFCPSTRet>0.00</vFCPSTRet><vProd>32.00</vProd><vFrete>0.00</vFrete><vSeg>0.00</vSeg><vDesc>0.00</vDesc><vII>0.00</vII><vIPI>0.00</vIPI><vIPIDevol>0.00</vIPIDevol><vPIS>0.00</vPIS><vCOFINS>0.00</vCOFINS><vOutro>0.00</vOutro><vNF>32.00</vNF><vTotTrib>4.64</vTotTrib></ICMSTot></total><transp><modFrete>9</modFrete></transp><pag><detPag><tPag>01</tPag><vPag>32.00</vPag></detPag></pag></infNFe><infNFeSupl><qrCode>http://www.sefaznet.ac.gov.br/nfce/qrcode?p=41190429982424000180650010000014411007910037|2|1|1|0FD6F88E485DB381DE629E9D918BDF68DFE5B265</qrCode><urlChave>http://www.sefaznet.ac.gov.br/nfce/consulta</urlChave></infNFeSupl><Signature xmlns=\"http://www.w3.org/2000/09/xmldsig#\"><SignedInfo><CanonicalizationMethod Algorithm=\"http://www.w3.org/TR/2001/REC-xml-c14n-20010315\"/><SignatureMethod Algorithm=\"http://www.w3.org/2000/09/xmldsig#rsa-sha1\"/><Reference URI=\"#NFe41190429982424000180650010000014411007910037\"><Transforms><Transform Algorithm=\"http://www.w3.org/2000/09/xmldsig#enveloped-signature\"/><Transform Algorithm=\"http://www.w3.org/TR/2001/REC-xml-c14n-20010315\"/></Transforms><DigestMethod Algorithm=\"http://www.w3.org/2000/09/xmldsig#sha1\"/><DigestValue>rofRQhS0xg2l+HKSvBULZsXkI+E=</DigestValue></Reference></SignedInfo><SignatureValue>dC3xSLs9c1e48Cyl0/c4egaStu2Px7v+GSM3Qfy0dg3BNAMFIqf+q1HOAnDpoatlnTCUDofKhsAvHV4GccLSbWZUK79U4YoTmfF4ucMfJ470+HzbXt3YXkBA8TJG23TADBoCn1Paah+502f//O/o5g1Q5NS6+5QUiiDUcqnItmFaJFvw0AEdx81hT+9VXV4CksbfToIyHswSiTOp3Rvje0dMzit2K22zd/l8VF55mD6i6d/Wt6JiErTYgBAEpug0WEkyGosJfvan8tooJqynjDrUi+MWwo3xx6CVtlZDGIt86WnyzG1unjdRi5EwmWH6RzCB8xiW0d/c6INfdOtSMQ==</SignatureValue><KeyInfo><X509Data><X509Certificate>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</X509Certificate></X509Data></KeyInfo></Signature></NFe></enviNFe>";
		TEnviNFe enviNFe = mapper.toObj(xmlEnviNFe, TEnviNFe.class);
		DadosRequisicao dados = DadosRequisicao.builder()
				.ambiente(1).modelo("65").tipoEmissao(TipoEmissao.NORMAL).versao("4.00").build();
		
		qrCodeService.colocaQrCode(enviNFe.getNFe().get(0), dados);
		assertThat(enviNFe.getNFe().get(0).getInfNFeSupl().getUrlChave()).isEqualTo("http://www.fazenda.pr.gov.br/nfce/consulta");
	}
}
